<!DOCTYPE html>
<html>
    <head>
    	<meta charset="utf-8">       
        <title>Pike - rpg example</title>
         <style>
        
	        html, body {
				overflow: hidden;
				width: 100%;
				height: 100%;
				margin:0;
				padding:0;
				border: 0;
			}
	        		
			#pike-stage{
				background:#eeeeee;
				margin:0 auto;
				border:5px solid #333;			
			}
			
			.xstats {
				position: absolute;
				top: 0;
				right: 0;
			 }			
		</style>
				
    <script src="../../../closure-library/closure/goog/base.js"></script>
    <script src="../../source/deps.js"></script>
	<script>
		goog.require('pike.assets.ImageManager');
		goog.require('pike.input.MouseInputHandler');
		goog.require('pike.core.Stage');
		goog.require('pike.core.Viewport');
		goog.require('pike.core.GameWorld');
		goog.require('pike.layers.DirtyManager');			
		goog.require('pike.layers.Layer');		
		goog.require('pike.core.Timer');
		goog.require('pike.core.Entity');
		goog.require('pike.components.Sprite');		
		goog.require('pike.events.ChangePosition');	
	</script>
	<script>
		window.onload = function(){
			
			var imageManager = new pike.assets.ImageManager();
			imageManager.load({
				"bg"		:"../img/bg.png",
				"entities"	:"../img/entities.png",
				"fg"		:"../img/fg.png"	
			}, onImageLoaded);
			
			function onImageLoaded(){				
				var timer = new pike.core.Timer();
				var gameWorld = new pike.core.GameWorld();
				var viewport = new pike.core.Viewport();
				
				var stage = new pike.core.Stage();
				stage.handler.listen(timer, pike.events.Render.EVENT_TYPE, goog.bind(stage.onRender, stage));
				stage.handler.listen(gameWorld, pike.events.ChangeSize.EVENT_TYPE, goog.bind(stage.onGameWorldChangeSize, stage));
				stage.handler.listen(viewport, pike.events.ChangeSize.EVENT_TYPE, goog.bind(stage.onViewportChangeSize, stage));
				stage.handler.listen(viewport, pike.events.ChangePosition.EVENT_TYPE, goog.bind(stage.onViewportChangePosition, stage));

				var mouse = new pike.input.MouseInputHandler();
				mouse.handler.listen(viewport, pike.events.ChangePosition.EVENT_TYPE, goog.bind(mouse.onViewportChangePosition, mouse));
							
				viewport.setSize(800,600);
				gameWorld.setSize(1280, 1280);
											
				//background						
				stage.addLayer( new pike.layers.Layer("background") );
								
				var bgEntity = new pike.core.Entity( pike.components.Image );
				bgEntity.setImage( imageManager.get("bg") );				
				bgEntity.handler.listen(bgEntity, pike.events.Render.EVENT_TYPE, goog.bind(bgEntity.onImageRender, bgEntity));				
				
				stage.getLayer('background').addEntity( bgEntity );
																													
				var hero = new pike.core.Entity( pike.components.Sprite, pike.components.Watch );
				hero.setSprite( imageManager.get("entities"), 0, 0, 32, 32, 3, 300);
				hero.onMouseDown = function(e){
					
					this.setDirty(this.getBounds());
					var oldX = this.x;
					var oldY = this.y;
					this.x = e.posX;
					this.y = e.posY;
					this.setDirty(this.getBounds());
					
					this.dispatchEvent( new pike.events.ChangePosition(this.x, this.y, oldX, oldY, null, this) );
					
					this.watchMe(viewport, gameWorld);
				};												
				hero.handler.listen(timer, pike.events.Update.EVENT_TYPE, goog.bind(hero.onSpriteUpdate, hero));
				hero.handler.listen(hero, pike.events.Render.EVENT_TYPE, goog.bind(hero.onSpriteRender, hero));
				hero.handler.listen( mouse, pike.events.Down.EVENT_TYPE, goog.bind( hero.onMouseDown, hero) );
				
				var enemy =  new pike.core.Entity( pike.components.Sprite );
				enemy.x = 150;
				enemy.y = 200;
				enemy.setSprite( imageManager.get("entities"), 96, 0, 32, 32, 3, 300);
				enemy.handler.listen(enemy, pike.events.Render.EVENT_TYPE, goog.bind(enemy.onSpriteRender, enemy));										
								
				
				var clustaLayer = new pike.layers.ClusterLayer("Clusta", 640);
				clustaLayer.setDirtyManager( new pike.layers.DirtyManager() );				
				clustaLayer.addEntity( hero );	
				clustaLayer.addEntity( enemy );				
				stage.addLayer( clustaLayer );
				
				
				//Foreground					
				stage.addLayer( new pike.layers.Layer("foreground"));
				mouse.setEventTarget( stage.getLayer('foreground').getScreen().canvas );
								
				var fgEntity = new pike.core.Entity( pike.components.Image );
				fgEntity.setImage( imageManager.get("fg") );				
				fgEntity.handler.listen(fgEntity, pike.events.Render.EVENT_TYPE, goog.bind(fgEntity.onImageRender, fgEntity));											
				
				stage.getLayer('foreground').addEntity( fgEntity );
																																
				timer.start();						
			}				
		}
	</script>
	
    </head>
    <body>                      
        <h1 align="center">Pike - rpg example</h1>
               
        <div id="pike-stage"></div>                     
                              
        <script src="../../libs/xstats/xstats.js"></script>
        <script>
        	var stats = new xStats;
			document.body.appendChild(stats.element);	
        </script>            
    </body>
</html>
