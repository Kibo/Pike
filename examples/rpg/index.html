<!DOCTYPE html>
<html>
    <head>
    	<meta charset="utf-8">       
        <title>Pike - rpg example</title>
         <style>
        
	        html, body {
				overflow: hidden;
				width: 100%;
				height: 100%;
				margin:0;
				padding:0;
				border: 0;
			}
	        		
			#pike-stage{
				background:#eeeeee;
				margin:0 auto;
				border:5px solid #333;			
			}
			
			.xstats {
				position: absolute;
				top: 0;
				right: 0;
			 }			
		</style>
				
    <script src="../../../closure-library/closure/goog/base.js"></script>
    <script src="../../source/deps.js"></script>
	<script>
		goog.require('pike.assets.ImageManager');
		goog.require('pike.input.MouseInputHandler');
		goog.require('pike.core.Stage');
		goog.require('pike.core.Viewport');
		goog.require('pike.core.GameWorld');
		goog.require('pike.layers.DirtyManager');			
		goog.require('pike.layers.Layer');		
		goog.require('pike.core.Timer');
		goog.require('pike.core.Entity');
		goog.require('pike.components.Sprite');		
		goog.require('pike.events.ViewportChangePosition');	
	</script>
	<script>
		window.onload = function(){
			
			var imageManager = new pike.assets.ImageManager();
			imageManager.load({
				"bg"		:"../img/bg.png",
				"entities"	:"../img/entities.png",
				"fg"		:"../img/fg.png"	
			}, onImageLoaded);
			
			function onImageLoaded(){				
				var timer = new pike.core.Timer();
				var viewport = new pike.core.Viewport();
				var gameWorld = new pike.core.GameWorld();
				
				var stage = new pike.core.Stage();			
				stage.handler.listen(timer, pike.events.Render.EVENT_TYPE, goog.bind(stage.onRender, stage));
				stage.handler.listen(viewport, pike.events.ChangeSize.EVENT_TYPE, goog.bind(stage.onViewportChangeSize, stage));
				stage.handler.listen(viewport, pike.events.ChangePosition.EVENT_TYPE, goog.bind(stage.onViewportChangePosition, stage));
				stage.handler.listen(gameWorld, pike.events.ChangeSize.EVENT_TYPE, goog.bind(stage.onGameWorldChangeSize, stage));
				
				viewport.setSize(600,400);
				
				//background						
				stage.addLayer( new pike.layers.Layer("background") );
								
				var bgEntity = new pike.core.Entity( pike.components.Image );
				bgEntity.setImage( imageManager.get("bg") );				
				bgEntity.handler.listen(stage.getLayer('background'), pike.events.Render.EVENT_TYPE, goog.bind(bgEntity.onImageRender, bgEntity));				
				
				stage.getLayer('background').addEntity( bgEntity );
				
				
				//Entities
				var layerEnt = new pike.layers.Layer("entities");
				layerEnt.setDirtyManager( new pike.layers.DirtyManager() );
				stage.addLayer( layerEnt );
																			
				var hero = new pike.core.Entity( pike.components.Sprite );
				hero.setSprite( imageManager.get("entities"), 0, 0, 32, 32, 3, 300);
				hero.onMouseDown = function(e){
					this.setDirty(this.getBounds());
					this.x = e.posX;
					this.y = e.posY;
					this.setDirty(this.getBounds());								
				};
													
				hero.handler.listen(timer, pike.events.Update.EVENT_TYPE, goog.bind(hero.onSpriteUpdate, hero));
				hero.handler.listen(stage.getLayer('entities'), pike.events.Render.EVENT_TYPE, goog.bind(hero.onSpriteRender, hero));				
											
				stage.getLayer('entities').addEntity( hero );
				
				
				//Foreground					
				stage.addLayer( new pike.layers.Layer("foreground"));
								
				var fgEntity = new pike.core.Entity( pike.components.Image );
				fgEntity.setImage( imageManager.get("fg") );				
				fgEntity.handler.listen(stage.getLayer('foreground'), pike.events.Render.EVENT_TYPE, goog.bind(fgEntity.onImageRender, fgEntity));				
				
				stage.getLayer('foreground').addEntity( fgEntity );
																
				var mouse = new pike.input.MouseInputHandler( stage.getLayer('foreground').getScreen().canvas );
				hero.handler.listen( mouse, pike.events.Down.EVENT_TYPE, goog.bind( hero.onMouseDown, hero) );
				
				timer.start();										
			}				
		}
	</script>
	
    </head>
    <body>                      
        <h1 align="center">Pike - rpg example</h1>
               
        <div id="pike-stage"></div>                     
                              
        <script src="../../libs/xstats/xstats.js"></script>
        <script>
        	var stats = new xStats;
			document.body.appendChild(stats.element);	
        </script>            
    </body>
</html>
