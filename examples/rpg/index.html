<!DOCTYPE html>
<html>
    <head>
    	<meta charset="utf-8">       
        <title>Pike - rpg example</title>
         <style>
        
	        html, body {
				overflow: hidden;
				width: 100%;
				height: 100%;
				margin:0;
				padding:0;
				border: 0;
			}
	        		
			#pike-stage{
				background:#eeeeee;
				margin:0 auto;
				border:5px solid #333;			
			}
			
			#bag{
				
			}
			
			.xstats {
				position: absolute;
				top: 0;
				right: 0;
			 }			
		</style>
				   
    <script src="../../../closure-library/closure/goog/base.js"></script>
    <script src="../../test/js/deps.js"></script>
    <script>
		goog.require('pike.assets.ImageManager');
		goog.require('pike.input.MouseInputHandler');
		goog.require('pike.core.Stage');
		goog.require('pike.core.Viewport');
		goog.require('pike.core.GameWorld');
		goog.require('pike.layers.DirtyManager');			
		goog.require('pike.layers.Layer');		
		goog.require('pike.core.Timer');
		goog.require('pike.core.Entity');
		goog.require('pike.components.Sprite');		
		goog.require('pike.events.ChangePosition');	
		goog.require('goog.dom');			
	</script>
	<script>
		window.onload = function(){
			
			goog.DEBUG = true;
			
			//Components
			
									
			//Assets
			var imageManager = new pike.assets.ImageManager();
			imageManager.load({
				"bg"		:"../img/bg.png",
				"entities"	:"../img/entities.png",
				"fg"		:"../img/fg.png"	
			}, onImageLoaded);
			
			function onImageLoaded(){																									
				var timer = new pike.core.Timer();
				var gameWorld = new pike.core.GameWorld();
				var viewport = new pike.core.Viewport();				
				var stage = new pike.core.Stage();						
																				
				stage.handler.listen(timer, pike.events.Render.EVENT_TYPE, goog.bind(stage.onRender, stage));
				stage.handler.listen(gameWorld, pike.events.ChangeSize.EVENT_TYPE, goog.bind(stage.onGameWorldChangeSize, stage));
				stage.handler.listen(viewport, pike.events.ChangeSize.EVENT_TYPE, goog.bind(stage.onViewportChangeSize, stage));
				stage.handler.listen(viewport, pike.events.ChangePosition.EVENT_TYPE, goog.bind(stage.onViewportChangePosition, stage));
																																
				var mouse = new pike.input.MouseInputHandler();
				mouse.handler.listen(viewport, pike.events.ChangePosition.EVENT_TYPE, goog.bind(mouse.onViewportChangePosition, mouse));
				mouse.setEventTarget( stage.getRootElement() );				
		
				viewport.setSize(800,600);
				gameWorld.setSize(1280, 1280);
											
				//background						
				stage.addLayer( new pike.layers.Layer("background") );
								
				var bgEntity = new pike.core.Entity( pike.components.Image );
				bgEntity.setImage( imageManager.get("bg") );				
				bgEntity.handler.listen(bgEntity, pike.events.Render.EVENT_TYPE, goog.bind(bgEntity.onImageRender, bgEntity));				
				
				stage.getLayer('background').addEntity( bgEntity );
									
				//Obstacles
				stage.addLayer( new pike.layers.ObstacleLayer("obstacles") );
				var obsLayer = stage.getLayer('obstacles');
				var obs = new pike.core.Entity( pike.components.Image );
				obs.setImage( imageManager.get("fg") );
				obs.handler.listen(obs, pike.events.Render.EVENT_TYPE, goog.bind(obs.onImageRender, obs));				
				
				obsLayer.addEntity( obs );
				
				//Entities
				var hero = new pike.core.Entity( pike.components.Sprite, pike.components.Watch, pike.components.Collision );
				hero.setSprite( imageManager.get("entities"), 0, 0, 32, 32, 3, 124);
				hero.setCollisionBounds(0,29,0,29);
				hero.onMouseDown = function(e){					
					this.targetX = e.posX;
					this.targetY = e.posY;	
					
					this.vx = this.targetX - this.x;
					this.vy = this.targetY - this.y;
					var magnitude = Math.sqrt((this.vx*this.vx)+(this.vy*this.vy));
																							
					this.positionAnimator = new pike.animation.Animator( (magnitude/ hero.SPEED) * 1000 );
					this.positionAnimator.setRepeatBehavior(pike.animation.Animator.LOOP)
					this.positionAnimator.setRepeatCount(1);
					this.positionAnimator.start();
					this.lastUpdate = new Date().getTime();	
					
					this.startX = this.x;
					this.startY = this.y;													
				};
				
				hero.SPEED = 120; // 2px * 60fps = 120px/sec 
				hero.onEnterFrame = function(e){
				
					if(this.targetX && this.targetX != this.x 
					|| this.targetY && this.targetY != this.y  ){
																	
						var now = e.now;
						var fraction = this.positionAnimator.update( (now - this.lastUpdate) )	
						this.lastUpdate = now;
																			
						if(!fraction){
							this.targetX = this.x;
							this.targetY = this.y;
							return
						};
																																					    					    					    					  
				    	this.setDirty(this.getBounds());
				    	var oldX = this.x;
						var oldY = this.y;
				    	this.x = this.startX + (this.vx * fraction);
				    	this.y = this.startY + (this.vy * fraction);
				    					    				   				    					    
				    	this.x = (0.5 + this.x) << 0; //round
				    	this.y = (0.5 + this.y) << 0; //round
				    					    					    					    					    					    					
				    	this.setDirty(this.getBounds());				    					    	
				    	this.dispatchEvent( new pike.events.ChangePosition(this.x, this.y, oldX, oldY, this) );				    	
				    	
				    	this.setSpriteRow(this.vx, this.vy);	
				    	this.onSpriteUpdate(e);
				    	
				    	this.watchMe(viewport, gameWorld);						
					}														
				};
				hero.onCollision = function(e){
					
					if(e.obj.hasComponent( pike.components.Backpack.NAME ) ){
						e.obj.putInBackpack();
						return;
					}
					
					this.x = e.oldX;
					this.y = e.oldY;
					this.targetX = e.oldX;
					this.targetY = e.oldY;
				}
								
				hero.handler.listen(timer, pike.events.Update.EVENT_TYPE, goog.bind(hero.onEnterFrame, hero));
				hero.handler.listen(hero, pike.events.Render.EVENT_TYPE, goog.bind(hero.onSpriteRender, hero));
				hero.handler.listen( mouse, pike.events.Down.EVENT_TYPE, goog.bind( hero.onMouseDown, hero) );
				
				hero.handler.listen( hero, pike.events.Collision.EVENT_TYPE, goog.bind( hero.onCollision, hero) );				
				//obsLayer.handler.listen(hero, pike.events.ChangePosition.EVENT_TYPE, goog.bind(obsLayer.onEntityChangePosition, obsLayer));
				
				var enemy =  new pike.core.Entity( pike.components.Sprite, pike.components.Collision);
				enemy.x = 150;
				enemy.y = 200;
				enemy.setSprite( imageManager.get("entities"), 96, 0, 32, 32, 3, 300);
				enemy.setCollisionBounds(0,29,0,29);
				enemy.handler.listen(enemy, pike.events.Render.EVENT_TYPE, goog.bind(enemy.onSpriteRender, enemy));	
								
				var cheese =  new pike.core.Entity( pike.components.Sprite, pike.components.Collision, pike.components.Backpack);
				cheese.x = 150;
				cheese.y = 300;
				cheese.setSprite( imageManager.get("entities"), 96, 96, 32, 32, 3, 300);
				cheese.setIconUrl("../img/cheese.png");
				cheese.handler.listen(cheese, pike.events.Render.EVENT_TYPE, goog.bind(cheese.onSpriteRender, cheese));
				cheese.onCollision = function(e){
					
					//player drop entity on collison area
					if(this.isOnBackpack()){
						this.setDropAcceptable(false);	
					}
					
					this.x = e.oldX;
					this.y = e.oldY;
					this.targetX = e.oldX;
					this.targetY = e.oldY;
				}
				cheese.handler.listen( cheese, pike.events.Collision.EVENT_TYPE, goog.bind( cheese.onCollision, cheese) );	
				//obsLayer.handler.listen(cheese, pike.events.ChangePosition.EVENT_TYPE, goog.bind(obsLayer.onEntityChangePosition, obsLayer));				
				
				var mickey =  new pike.core.Entity( pike.components.Sprite, pike.components.Backpack);
				mickey.x = 300;
				mickey.y = 300;
				mickey.setSprite( imageManager.get("entities"), 96, 96, 32, 32, 3, 300);
				mickey.setIconUrl("../img/mouse.png");
				mickey.handler.listen(mickey, pike.events.Render.EVENT_TYPE, goog.bind(mickey.onSpriteRender, mickey));
															
				var clustaLayer = new pike.layers.ClusterLayer("Clusta", 250);
				clustaLayer.setDirtyManager( new pike.layers.DirtyManager() );				
				clustaLayer.addEntity( hero );	
				clustaLayer.addEntity( enemy );	
				clustaLayer.addEntity( cheese );
				clustaLayer.addEntity( mickey );	
				stage.addLayer( clustaLayer );
								
				//Foreground					
				stage.addLayer( new pike.layers.Layer("foreground"));
														
				var fgEntity = new pike.core.Entity( pike.components.Image );
				fgEntity.setImage( imageManager.get("fg") );				
				fgEntity.handler.listen(fgEntity, pike.events.Render.EVENT_TYPE, goog.bind(fgEntity.onImageRender, fgEntity));											
				
				stage.getLayer('foreground').addEntity( fgEntity );
																				 	
				timer.start();						
			}				
		}
	</script>
	
    </head>
    <body>                      
        <h1 align="center">Pike - rpg example</h1>
               
        <div id="pike-stage"></div>
        <div id="pike-backpack"></div>                       
                              
        <script src="../../libs/xstats/xstats.js"></script>
        <script>
        	var stats = new xStats;
			document.body.appendChild(stats.element);	
        </script>            
    </body>
</html>
